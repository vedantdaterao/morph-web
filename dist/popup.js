const a=document.getElementById("masterToggle"),p=document.getElementById("masterLabelText");chrome.storage.sync.get({enabled:!0},({enabled:e})=>{a.checked=e,p.textContent=e?"Extension Enabled":"Extension Disabled"});a.addEventListener("change",()=>{const e=a.checked;p.textContent=e?"Extension Enabled":"Extension Disabled",chrome.storage.sync.set({enabled:e}),chrome.tabs.query({active:!0,currentWindow:!0},([t])=>{t?.id&&chrome.tabs.sendMessage(t.id,{type:"toggleExtension",enabled:e})})});const d=document.getElementById("url");async function g(){const t=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];t?.url?d.textContent=t.url:d.textContent="Unable to get URL"}g();document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");document.querySelectorAll(".tab").forEach(s=>s.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".tab-content").forEach(s=>{s.classList.toggle("active",s.id===t)})})});const h=document.getElementById("selectorInput"),y=document.getElementById("hideButton"),m=document.getElementById("selectorList");async function i(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return new URL(e.url).hostname}async function l(){const e=await i(),s=(await chrome.storage.sync.get(e))[e]?.selectors||[];m.innerHTML="",s.forEach(r=>{const n=document.createElement("li"),c=document.createElement("button");c.textContent="-",c.style.marginRight="8px",c.addEventListener("click",async()=>{await f(r),await l();const[u]=await chrome.tabs.query({active:!0,currentWindow:!0});u?.id&&chrome.tabs.sendMessage(u.id,{type:"refreshSelectors"})}),n.appendChild(c),n.appendChild(document.createTextNode(r)),m.appendChild(n)})}async function b(e){const t=await i(),r=(await chrome.storage.sync.get(t))[t]?.selectors||[];r.includes(e)||(r.push(e),await chrome.storage.sync.set({[t]:{selectors:r}}))}async function f(e){const t=await i(),n=((await chrome.storage.sync.get(t))[t]?.selectors||[]).filter(c=>c!==e);await chrome.storage.sync.set({[t]:{selectors:n}})}y.addEventListener("click",async()=>{const e=h.value.trim();if(!e)return;await b(e),await l(),h.value="";const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t?.id&&chrome.tabs.sendMessage(t.id,{type:"refreshSelectors"})});l();const E=document.getElementById("extractButton"),o=document.getElementById("extractResult");async function w(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e}E.addEventListener("click",async()=>{o.innerHTML="<p>Running detectors...</p>";const e=await w();if(!e?.id||!e.url){o.innerHTML="<p>No active tab</p>";return}let t=null;try{t=await chrome.tabs.sendMessage(e.id,{type:"runDetector"})}catch{t={error:"Content script not reachable"}}let s=null;try{s=await chrome.runtime.sendMessage({type:"fetchHeaders",url:e.url})}catch(n){s={ok:!1,error:n instanceof Error?n.message:String(n)}}const r=[];if(r.push("<h4>Page Info</h4>"),r.push(`<p><strong>URL:</strong> ${e.url}</p>`),t?.title&&r.push(`<p><strong>Title:</strong> ${t.title}</p>`),r.push("<h4>Detected Frameworks / Libraries</h4>"),t?.results?.length?(r.push("<ul>"),t.results.forEach(n=>{r.push(`<li><strong>${n.name}</strong> â€” ${n.reason}${n.version?` (v${n.version})`:""}</li>`)}),r.push("</ul>")):t?.error?r.push(`<p style="color: red;">${t.error}</p>`):r.push("<p>None detected</p>"),r.push("<h4>Important Headers</h4>"),s?.ok&&s.headers){const n=["server","x-powered-by","cf-ray","cf-cache-status","content-security-policy","strict-transport-security"];r.push("<ul>"),n.forEach(c=>{s.headers[c]&&r.push(`<li><strong>${c}:</strong> ${s.headers[c]}</li>`)}),r.push("</ul>")}else s?.error&&r.push(`<p style="color: red;">${s.error}</p>`);o.innerHTML=r.join("")});
